<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Create Exam</title>
  <link rel="stylesheet" href="style.css">
</head>
<body onload="fillCourseInfo()">
  <div class="exam-container">
    <h2><span id="course-info"></span></h2>
    <h2><span id="section-info"></span></h2>

    <input type="text" id="exam-title" placeholder="Exam Title">
    <div style="height: 10px;"></div>

    <input type="number" id="time-limit" placeholder="Time Limit (minutes)" min="1">
    <div style="height: 10px;"></div>

    <div id="question-form">
      <div class="question-block">
        <h3>Question 1</h3>
        <input type="text" class="question-text" placeholder="Enter Question">
        <input type="text" class="option" placeholder="Option 1">
        <!--<input type="text" class="option" placeholder="Option 2">
        <input type="text" class="option" placeholder="Option 3">
        <input type="text" class="option" placeholder="Option 4">-->
        <input type="number" class="correct-option" placeholder="Correct Option (1-4)" min="1" max="4">
      </div>
    </div>

    <div style="height: 10px;"></div>
    <button id="add-question-btn">Add Another Question</button>
    <div style="height: 10px;"></div>
    <button id="submit-exam-btn">Publish Exam</button>
    <div style="height: 10px;"></div>
    <button onclick="window.location.href='instructor.html'">Back</button>
    <div style="height: 10px;"></div>

    <p id="message" style="color: red;"></p>
  </div>

  <script src="data.js"></script>
  <script src="script.js"></script>
  <script>
      async function fillCourseInfo() {
        const section_id = localStorage.getItem("selectedCourse");
        const section_info = await getSectionInfo(parseInt(section_id));
        let courseElement = document.getElementById("course-info");
        let sectionElement = document.getElementById("section-info");
        courseElement.textContent=`${section_info.course_name}`;
        sectionElement.textContent=`${section_info.course}-${section_info.id}`;
      }

    function createQuestion(){
      let question = document.createElement("input");
      let answers = []

    }

    var questionCount = 1;

    function isFilled(container) {
      var questionText = container.querySelector(".question-text").value;
      var options = container.querySelectorAll(".option");
      //replace with Checkboxes
      var answer = container.querySelector(".correct-option").value;
      if (questionText === "") return false;
      for (var i = 0; i < options.length; i++) {
        if (options[i].value === "") return false;
      }
      if (answer === "" || answer < 1 || answer > 4) return false;
      return true;
      //Create variable number of questions
    }

    document.getElementById("add-question-btn").onclick = function () {
      var blocks = document.getElementsByClassName("question-block");
      var lastBlock = blocks[blocks.length - 1];
      if (!isFilled(lastBlock)) {
        document.getElementById("message").textContent = "Please fill out all fields.";
        return;
      }

      questionCount++;
      var div = document.createElement("div");
      div.className = "question-block";
      div.innerHTML =
        "<h3>Question " + questionCount + "</h3>" +
        "<input type='text' class='question-text' placeholder='Enter Question'>" +
        "<input type='text' class='option' placeholder='Option 1'>" +
        "<input type='text' class='option' placeholder='Option 2'>" +
        "<input type='text' class='option' placeholder='Option 3'>" +
        "<input type='text' class='option' placeholder='Option 4'>" +
        "<input type='number' class='correct-option' placeholder='Correct Option (1-4)' min='1' max='4'>";
      document.getElementById("question-form").appendChild(div);
      document.getElementById("message").textContent = "";
    }

    document.getElementById("submit-exam-btn").onclick = function () {
      var title = document.getElementById("exam-title").value;
      var time = document.getElementById("time-limit").value;
      if (title === "") {
        document.getElementById("message").textContent = "Exam title is required.";
        return;
      }
      if (time === "" || time <= 0) {
        document.getElementById("message").textContent = "Enter a valid time.";
        return;
      }

      var blocks = document.getElementsByClassName("question-block");
      var questions = [];
      for (var i = 0; i < blocks.length; i++) {
        var box = blocks[i];
        if (!isFilled(box)) {
          document.getElementById("message").textContent = "All questions must be filled.";
          return;
        }
        var q = box.querySelector(".question-text").value;
        var opts = [];
        var optInputs = box.querySelectorAll(".option");
        for (var j = 0; j < optInputs.length; j++) {
          opts.push(optInputs[j].value);
        }
        var ans = parseInt(box.querySelector(".correct-option").value) - 1;
        questions.push({ question: q, options: opts, answer: ans });
      }

      addExam(title, questions, course, parseInt(time));
      localStorage.removeItem("selectedCourse");
      window.location.href = "instructor.html";
    }
  </script>
</body>
</html>